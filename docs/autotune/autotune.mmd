---
config:
  theme: neo-dark
  layout: elk
  flowchart:
    curve: linear
    nodeSpacing: 50
    rankSpacing: 60
    padding: 15
    htmlLabels: false
    useMaxWidth: false
    diagramPadding: 15
---

flowchart TD

%% =====================
%% ğŸ¯ PROCESO DE AUTOTUNING PID
%% TriptaLabs Heat Controller
%% =====================

%% DefiniciÃ³n de subgrafos principales
subgraph INIT["ğŸ”§ INICIALIZACIÃ“N"]
    A1["ğŸ“¤ Desactivar PID Normal<br/>pid.enabled = false"]
    A2["ğŸ“‹ Cargar ParÃ¡metros Config<br/>â€¢ hysteresis = 0.5Â°C<br/>â€¢ relay_high = 100.0%<br/>â€¢ relay_low = 0.0%<br/>â€¢ min_cycles = 5<br/>â€¢ delay_ms = 100ms"]
    A3["ğŸ¯ Setpoint Fijo<br/>setpoint = 50.0Â°C"]
    A4["ğŸ”„ Inicializar Variables<br/>â€¢ cycleCount = 0<br/>â€¢ periodSum = 0.0<br/>â€¢ tempMax = -1000.0<br/>â€¢ tempMin = 1000.0<br/>â€¢ relayState = false"]
end

subgraph CYCLE["ğŸ” CICLO DE OSCILACIÃ“N (RELAY FEEDBACK)"]
    B1["ğŸ“Š Leer Temperatura<br/>currentTemp = read_ema_temp()"]
    B2["ğŸ“ˆ Actualizar Extremos<br/>if (currentTemp > tempMax) tempMax = currentTemp<br/>if (currentTemp < tempMin) tempMin = currentTemp"]
    B3{"ğŸŒ¡ï¸ Comparar Temperatura<br/>vs Setpoint + HistÃ©resis"}
    B4["ğŸ”Œ ENCENDER SSR<br/>relayState = true<br/>CH422G_od_output(0x00)"]
    B5["âš¡ APAGAR SSR<br/>relayState = false<br/>CH422G_od_output(0x02)"]
    B6["â±ï¸ Medir PerÃ­odo<br/>period = (now - lastOnTick) / 1000.0<br/>periodSum += period<br/>cycleCount++"]
    B7["â³ Delay de Ciclo<br/>vTaskDelay(100ms)"]
    B8{"ğŸ“Š Â¿Ciclos Completos?<br/>cycleCount >= 5"}
end

subgraph CALC["ğŸ§® CÃLCULO ZIEGLER-NICHOLS"]
    C1["ğŸ“ PerÃ­odo Promedio<br/>Pu = periodSum / cycleCount"]
    C2["ğŸ“Š Amplitud de OscilaciÃ³n<br/>amplitude = (tempMax - tempMin) / 2.0"]
    C3["ğŸ”„ Ganancia CrÃ­tica<br/>d = (relay_high - relay_low) / 2.0<br/>Ku = (4.0 * d) / (Ï€ * amplitude)"]
    C4["âš™ï¸ ParÃ¡metros PID Finales<br/>Kp = 0.6 * Ku<br/>Ki = 1.2 * Ku / Pu<br/>Kd = 0.075 * Ku * Pu"]
end

subgraph FINISH["âœ… FINALIZACIÃ“N"]
    D1["ğŸ’¾ Guardar ParÃ¡metros<br/>pid_set_params(new_kp, new_ki, new_kd)"]
    D2["ğŸ“‹ Mostrar Resultados<br/>printf('Kp=%.4f, Ki=%.4f, Kd=%.4f')"]
    D3["ğŸ—‘ï¸ Eliminar Tarea<br/>vTaskDelete(NULL)"]
end

subgraph CONFIG["ğŸ“ CONFIGURACIÃ“N ACTUAL"]
    E1["ğŸ›ï¸ PARÃMETROS DE AUTOTUNING<br/>autotune_hysteresis = 0.5Â°C<br/>autotune_relay_high = 100.0%<br/>autotune_relay_low = 0.0%<br/>autotune_min_cycles = 5<br/>autotune_delay_ms = 100ms"]
    E2["âš™ï¸ VALORES PID INICIALES<br/>kp_default = 1.0<br/>ki_default = 0.1<br/>kd_default = 2.0"]
    E3["ğŸš« ESTADO ACTUAL<br/>#if 0 (COMENTADO)<br/>FunciÃ³n no utilizada"]
end

subgraph CONTROL["ğŸ® LÃ“GICA DE CONTROL SSR"]
    F1["ğŸŒ¡ï¸ Temp < SP - 0.5Â°C<br/>Y relayState = false"]
    F2["ğŸŒ¡ï¸ Temp > SP + 0.5Â°C<br/>Y relayState = true"]
    F3["ğŸ“ˆ CONDICIÃ“N ENCENDIDO<br/>Temperatura BAJO setpoint"]
    F4["ğŸ“‰ CONDICIÃ“N APAGADO<br/>Temperatura SOBRE setpoint"]
end

%% =====================
%% CONEXIONES PRINCIPALES
%% =====================

%% Secuencia principal
A1 --> A2 --> A3 --> A4 --> B1

%% Ciclo de control
B1 --> B2 --> B3
B3 --> F1
B3 --> F2
F1 --> B4 --> B6
F2 --> B5
B4 --> B7
B5 --> B7
B6 --> B7
B7 --> B8
B8 -->|No| B1
B8 -->|SÃ­| C1

%% CÃ¡lculos
C1 --> C2 --> C3 --> C4

%% FinalizaciÃ³n
C4 --> D1 --> D2 --> D3

%% ConfiguraciÃ³n
E1 -.->|"Utiliza"| A2
E2 -.->|"Valores por defecto"| A4
E3 -.->|"Estado"| A1

%% Control detallado
F3 -.->|"Implementa"| F1
F4 -.->|"Implementa"| F2

%% =====================
%% ESTILOS Y COLORES
%% =====================

%% InicializaciÃ³n - Azul
style A1 fill:#4FC3F7,stroke:#0277BD,color:#000000
style A2 fill:#4FC3F7,stroke:#0277BD,color:#000000
style A3 fill:#4FC3F7,stroke:#0277BD,color:#000000
style A4 fill:#4FC3F7,stroke:#0277BD,color:#000000

%% Ciclo - Verde
style B1 fill:#66BB6A,stroke:#388E3C,color:#000000
style B2 fill:#66BB6A,stroke:#388E3C,color:#000000
style B3 fill:#FFB74D,stroke:#F57C00,color:#000000
style B4 fill:#FF8A65,stroke:#D84315,color:#000000
style B5 fill:#9575CD,stroke:#512DA8,color:#000000
style B6 fill:#66BB6A,stroke:#388E3C,color:#000000
style B7 fill:#66BB6A,stroke:#388E3C,color:#000000
style B8 fill:#FFB74D,stroke:#F57C00,color:#000000

%% CÃ¡lculos - Naranja
style C1 fill:#FFB74D,stroke:#F57C00,color:#000000
style C2 fill:#FFB74D,stroke:#F57C00,color:#000000
style C3 fill:#FFB74D,stroke:#F57C00,color:#000000
style C4 fill:#FFB74D,stroke:#F57C00,color:#000000

%% FinalizaciÃ³n - Verde oscuro
style D1 fill:#4CAF50,stroke:#2E7D32,color:#000000
style D2 fill:#4CAF50,stroke:#2E7D32,color:#000000
style D3 fill:#4CAF50,stroke:#2E7D32,color:#000000

%% ConfiguraciÃ³n - Gris
style E1 fill:#BDBDBD,stroke:#616161,color:#000000
style E2 fill:#BDBDBD,stroke:#616161,color:#000000
style E3 fill:#F44336,stroke:#D32F2F,color:#FFFFFF

%% Control - Amarillo
style F1 fill:#FFF176,stroke:#FBC02D,color:#000000
style F2 fill:#FFF176,stroke:#FBC02D,color:#000000
style F3 fill:#FFF176,stroke:#FBC02D,color:#000000
style F4 fill:#FFF176,stroke:#FBC02D,color:#000000

%% =====================
%% NOTAS TÃ‰CNICAS
%% =====================

%% Agregar notas explicativas
subgraph NOTES["ğŸ“š NOTAS TÃ‰CNICAS"]
    N1["ğŸ”¬ MÃ‰TODO ZIEGLER-NICHOLS<br/>â€¢ Relay Feedback Method<br/>â€¢ OscilaciÃ³n controlada del sistema<br/>â€¢ CÃ¡lculo de ganancia crÃ­tica (Ku)<br/>â€¢ PerÃ­odo crÃ­tico (Pu)"]
    N2["âš¡ CONTROL SSR<br/>â€¢ CH422G_od_output(0x00) = ON<br/>â€¢ CH422G_od_output(0x02) = OFF<br/>â€¢ Relay feedback con histÃ©resis"]
    N3["ğŸ“Š FÃ“RMULAS ZN<br/>â€¢ Ku = (4*d)/(Ï€*amplitude)<br/>â€¢ d = (relay_high - relay_low)/2<br/>â€¢ Kp = 0.6 * Ku<br/>â€¢ Ki = 1.2 * Ku / Pu<br/>â€¢ Kd = 0.075 * Ku * Pu"]
    N4["ğŸš« ESTADO ACTUAL<br/>CÃ³digo funcional pero deshabilitado<br/>Comentado con #if 0<br/>No hay API pÃºblica"]
end

style N1 fill:#E1F5FE,stroke:#0277BD,color:#000000
style N2 fill:#E8F5E8,stroke:#388E3C,color:#000000  
style N3 fill:#FFF3E0,stroke:#F57C00,color:#000000
style N4 fill:#FFEBEE,stroke:#D32F2F,color:#000000 