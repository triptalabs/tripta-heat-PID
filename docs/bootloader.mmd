---
config:
  layout: fixed
---
flowchart TD
 subgraph subGraph0["ğŸ’¾ Variables NVS CrÃ­ticas"]
        AU["ğŸ” firmware_hash<br>(SHA256 del firmware)"]
        AV["ğŸ”¢ boot_attempts<br>(0-3, resetea en boot exitoso)"]
        AW["ğŸš¨ recovery_flag<br>(true/false)"]
        AX["â° last_boot_time<br>(timestamp Ãºltimo boot)"]
  end
 subgraph subGraph1["ğŸ” Criterios RazÃ³n de Arranque"]
        AY["ğŸ†• PRIMER ARRANQUE:<br>â€¢ firmware_hash no existe en NVS<br>â€¢ O NVS vacÃ­o/corrupto"]
        AZ["ğŸ” ARRANQUE NORMAL:<br>â€¢ firmware_hash existe<br>â€¢ recovery_flag = false<br>â€¢ boot_attempts &lt; 3"]
        BA["ğŸš¨ MODO RECUPERACIÃ“N:<br>â€¢ recovery_flag = true<br>â€¢ O boot_attempts &gt;= 3<br>â€¢ O activaciÃ³n manual"]
  end
 subgraph subGraph2["ğŸ’¾ DistribuciÃ³n Memoria"]
        BB["ğŸ“¦ Particiones (10MB Total)"]
        BC["ğŸ”§ app0: 10MB<br>(AplicaciÃ³n Principal)"]
        BD["ğŸ’¾ nvs: 1MB<br>(Config + Variables Boot)"]
        BE["ğŸ“ spiffs: 2MB<br>(Datos Usuario)"]
  end
    A["ğŸ”Œ Encendido ESP32-S3"] --> B["ğŸš€ Bootloader ESP-IDF"]
    B --> C["ğŸ“± Inicio App (main/core/main.c)"]
    C --> D["ğŸ›¡ï¸ InicializaciÃ³n Bootloader<br>(bootloader_main.c)"]
    D --> E["ğŸ” Determinar RazÃ³n de Arranque"]
    E --> F{"ğŸ“Š Leer NVS"}
    F -- Hash no existe --> G["ğŸ†• PRIMER ARRANQUE<br>â€¢ Sin hash previo<br>â€¢ Firmware nuevo"]
    F -- Hash existe --> H["ğŸ” ARRANQUE NORMAL<br>â€¢ Hash encontrado<br>â€¢ Verificar integridad"]
    F -- "Flag recovery=true" --> I["ğŸš¨ MODO RECUPERACIÃ“N<br>â€¢ Flag manual activado<br>â€¢ O falla crÃ­tica previa"]
    G --> J["ğŸ“ Generar Hash SHA256<br>(integrity_checker.c)"]
    J --> K["ğŸ’¾ Guardar Hash en NVS"]
    K --> L["âœ… Continuar a AplicaciÃ³n"]
    H --> M["ğŸ” Verificar Integridad Firmware<br>(Comparar SHA256 actual vs NVS)"]
    M --> N{"âœ… Hash Coincide?"}
    N -- SÃ­ --> O["ğŸ“Š boot_attempts = 0"]
    N -- No --> P["âš ï¸ boot_attempts++"]
    O --> L
    P --> Q{"ğŸ”¢ boot_attempts >= 3?"}
    Q -- No --> R["ğŸ’¾ recovery_flag = false<br>ğŸ“ Guardar en NVS"]
    Q -- SÃ­ --> S["ğŸ†˜ recovery_flag = true<br>ğŸ’¾ Guardar en NVS<br>ğŸ”„ esp_restart()"]
    R --> T["ğŸ”„ Reiniciar ESP32<br>(Reintentar arranque)"]
    T --> B
    S --> U["ğŸ”„ Reiniciar â†’ Modo RecuperaciÃ³n"]
    U --> B
    I --> V["ğŸ“º Mostrar MenÃº RecuperaciÃ³n<br>(recovery_mode.c)"]
    V --> W{"ğŸ‘¤ ElecciÃ³n Usuario"}
    W -- RecuperaciÃ³n SD --> X["ğŸ—‚ï¸ Proceso RecuperaciÃ³n SD"]
    W -- RecuperaciÃ³n UART --> Y["ğŸ’» Interfaz UART"]
    W -- Info Sistema --> Z["ğŸ“‹ Estado del Sistema"]
    W -- Reiniciar Normal --> AA["ğŸ”„ recovery_flag = false<br>Reiniciar"]
    X --> AB["ğŸ” Montar Tarjeta SD"]
    AB --> AC{"ğŸ“ SD Encontrada?"}
    AC -- No --> AD["âŒ Error: SD no encontrada"]
    AC -- SÃ­ --> AE["ğŸ” Buscar Archivos Firmware"]
    AE --> AF["ğŸ“‚ Verificar /sdcard/recovery/<br>1ï¸âƒ£ update.bin (prioridad)<br>2ï¸âƒ£ base_firmware.bin"]
    AF --> AG{"ğŸ“„ Archivos Encontrados?"}
    AG -- No --> AH["âŒ Sin archivos de recuperaciÃ³n"]
    AG -- SÃ­ --> AI["ğŸ” Verificar SHA256 archivo"]
    AI --> AJ{"âœ… Archivo VÃ¡lido?"}
    AJ -- No --> AK["âŒ Archivo corrupto"]
    AJ -- SÃ­ --> AL["âš¡ Flashear a particiÃ³n app0"]
    AL --> AM["ğŸ“ Actualizar hash en NVS"]
    AM --> AN["ğŸ’¾ recovery_flag = false"]
    AN --> AO["ğŸ”„ Reiniciar ESP32"]
    AO --> B
    Y --> AP["ğŸ’¬ Comandos UART disponibles:<br>â€¢ info - InformaciÃ³n sistema<br>â€¢ recovery - Iniciar recuperaciÃ³n SD<br>â€¢ reboot - Reiniciar normal<br>â€¢ factory - Reset de fÃ¡brica"]
    Z --> AQ["ğŸ“Š InformaciÃ³n del Sistema:<br>â€¢ Hash actual firmware<br>â€¢ Intentos arranque: {boot_attempts}<br>â€¢ Flag recuperaciÃ³n: {recovery_flag}<br>â€¢ Ãšltimo arranque exitoso<br>â€¢ Espacio libre particiones"]
    AD --> AR["ğŸ”„ Volver al MenÃº"]
    AH --> AR
    AK --> AR
    AR --> V
    AA --> AS["ğŸ”„ Reiniciar con recovery_flag=false"]
    AS --> B
    L --> AT["ğŸ¯ TriptaLabs Heat Controller<br>AplicaciÃ³n Principal"]
    BB --> BC & BD & BE
    style G fill:#51cf66
    style H fill:#74c0fc
    style I fill:#ff8787
    style L fill:#51cf66
    style X fill:#ffd43b
    style AT fill:#51cf66
